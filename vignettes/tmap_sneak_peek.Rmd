---
title: "tmap v4: a sneak peek"
author: "Martijn Tennekes"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 2
link-citations: yes
vignette: >
  \usepackage[utf8]{inputenc}
  %\VignetteIndexEntry{tmap v4: a sneak peek}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 9, warning = FALSE)
```

```{r, echo = FALSE, message = FALSE}
library(tmap)
data(World, metro)
#tmap_design_mode()
```

The next major update of **tmap** will be a massive one. 
Although **tmap** is well-known and widely used in the R spatial community, there are a couple of bottlenecks that make it difficult to maintain and extend.
The upcoming **tmap** version 4 (**tmap v4**) aims to overcome these shortcomings.
It is still fully in the development, but now is a good time for a sneak peek.

## Aesthetics

First and foremost, the number of aesthetics (by which we mean visual variables) will be much greater, as will be illustrated below. 
Moreover, it will make it much easier for developers to add new aesthetics.

The arguments that specify aesthetics themselves will remain the same.
E.g., the main aesthetic in `tm_polygons` is `fill`, which defines the fill color of the polygons.

However, the other arguments of the layer functions are organized differently. 
Thus, each aesthetic will only have four arguments: 

- the aesthetic itself (`fill`)
- the scale (`fill.scale`)
- the legend (`fill.legend`)
- an argument that decides whether scales are applied freely across facets (`fill.free`)

The scales and legends are discussed in the next sections.

Below you can see a basic comparison of the **tmap** version 3 and 4 syntax:

```{r, eval = FALSE, class.source='bg-warning'}
# tmap 3
tm_shape(World) +
  tm_polygons(fill, palette = "RdYlGn", title = "Happy Planet Index")
```

```{r, class.source='bg-success'}
# tmap 4
tm_shape(World) +
	tm_polygons(fill = "HPI", 
				fill.scale = tm_scale_intervals(values = "RdYlGn"), 
				fill.legend = tm_legend(title = "Happy Planet Index"))
```

To illustrate the large number of aesthetics: in **tmap v4**, `tm_polygons` will have the aesthetics `fill`, `col`, `fill_alpha`, `col_alpha`, `lwd`, `lty`, and eventually also `pattern`. 
A data variable can be mapped to each of them, using different scales (see next section for an overview).
The next example uses `fill`, `lwd` (line width), and `lty` (line type) as aesthetics:

```{r, eval = FALSE, class.source='bg-warning'}
# tmap 3
# ... not possible :(
```

```{r fig.height = 6, fig.width=9, class.source='bg-success'}
# tmap 4
World$life_exp_class = cut(World$life_exp, breaks = seq(40, 85, by = 15))

tm_shape(World, crs = "+proj=eck4") +
	tm_polygons(fill = "HPI", 
				fill.scale = tm_scale_continuous(values = "RdYlGn"), 
				fill.legend = tm_legend(title = "Happy Planet Index"),
				lwd = "well_being",
				lwd.scale = tm_scale_continuous(value.neutral = 1, 
				                                values = c(0, 5),
				                                label.na = ""),
				lwd.legend = tm_legend(title = "Well Being",
				                       space = 0.5),
				lty = "life_exp_class",
				lty.scale = tm_scale_ordinal(values = c("dotted", "dashed", "solid"), 
				                             value.na = "blank", 
				                             value.neutral = "solid",
				                             label.na = ""),
				lty.legend = tm_legend(title = "Life Expectancy", 
				                       space = 0.5)
	)
```

Besides these **visual aesthetics**, which map data variables to visual variables, there is also another group of aesthetics, namely **transformation aesthetics**.
They are used to transform spatial objects.
An example of **transformation aesthetics** is the cartogram, where polygons are distorted such that the size will be (approximately) proportional to a data variable.

Cartograms could already be made with tmap v3, but it explicitly required transforming the data using the **cartogram** package before mapping.

```{r, eval=FALSE, class.source='bg-warning'}
# tmap 3
library(cartogram)
World_carto = World |>
  sf::st_transform(World, crs = "+proj=eck4") |>
  cartogram_cont(weight = "pop_est")

tm_shape(World_carto, crs = "+proj=eck4") +
  tm_polygons(fill, 
              palette = "RdYlGn", 
              title = "Happy Planet Index")
```

In **tmap v4**, there will be a direct function `tm_cartogram` (using the **cartogram** package under the hood), which uses the transformation aesthetic `size` and inherits all visual aesthetics from `tm_polygons`:

```{r, class.source='bg-success',message=FALSE}
# tmap 4
tm_shape(World, crs = "+proj=eck4") +
	tm_cartogram(size = "pop_est",
				 fill = "HPI", 
				 fill.scale = tm_scale_intervals(values = "RdYlGn"),
				 fill.legend = tm_legend(title = "Happy Planet Index")) +
	tm_place_legends_right(width = 0.2)
```

A nice benefit of having cartograms directly in **tmap** is that it makes possible to use the available scaling functions. 
For example, suppose we want to apply a log 10 scale in order to make the cartogram a bit more balanced:

```{r, eval=FALSE, class.source='bg-warning'}
# tmap 3
library(cartogram)
World_carto = World |>
  sf::st_transform(World, crs = "+proj=eck4") |>
  dplyr::mutate(pop_est_log10 = log10(pop_est)) |>
  cartogram_cont(weight = "pop_est_log10")

tm_shape(World_carto) +
  tm_polygons(fill, 
              palette = "RdYlGn", 
              title = "Happy Planet Index")
```


```{r, class.source='bg-success',message=FALSE}
tm_shape(World, crs = "+proj=eck4") +
	tm_cartogram(size = "pop_est",
				 size.scale = tm_scale_log10(),
				 fill = "HPI", 
				 fill.scale = tm_scale_intervals(values = "RdYlGn"),
				 fill.legend = tm_legend(title = "Happy Planet Index")) +
	tm_place_legends_right(width = 0.2)
```

(We haven't decided whether to include `tm_cartogram` in the **tmap** package or in an extension package, e.g., **tmapCartogram** or **tmapExtra**.
Let us know your opinion at https://github.com/mtennekes/tmap/issues/565)

## Scales

## Legends

As you may have noticed in the previous examples, the legends look a bit differently by default.

### Positioning

Legends are placed outside the map by default in **tmap v4**.
Why? Simply because there is often more space than inside the map.

Furthermore, it is possible to place legends on different locations across the map:

```{r, eval = FALSE, class.source='bg-warning'}
# tmap 3
# ... not possible :(
```

```{r fig.height = 6, fig.width=9, class.source='bg-success'}
# tmap 4
tm_shape(World) +
  tm_symbols(fill = "HPI",
             size = "pop_est",
             shape = "income_grp",
  		     size.scale = tm_scale_auto(value.neutral = 0.5),
             fill.legend = tm_legend("Happy Planet Index", position = tm_lp_inset("left", "top")),
             size.legend = tm_legend("Population", position = tm_lp_out("left", "center")),
             shape.legend = tm_legend("Income Group", position = tm_lp_out("center", "bottom"), space = 0.5))
```

**tmap v3** contains many (often complicated) options for rather simple things.
These options are set globally via `tmap_options` or within a single plot with `tm_layout`.

In **tmap v**4, the complicated options are still there, and available via `tmap_options` and `tm_options`.
However, to ease its use, there will be a bunch of handy shortcut functions, such as `tm_place_legends_left`:

```{r, eval = FALSE, class.source='bg-warning'}
# tmap 3
tm_shape(World) +
  tm_symbols(fill = "HPI",
             size = "pop_est",
             shape = "income_grp") +
tm_layout(legend.outside.position = "left", legend.outside.size = 0.2)
```

```{r fig.height = 6, fig.width=9, class.source='bg-success'}
# tmap 4
tm_shape(World) +
  tm_symbols(fill = "HPI",
             size = "pop_est",
             shape = "income_grp",
  		     size.scale = tm_scale_auto(value.neutral = 0.5)) +
tm_place_legends_left(0.2)
```

### Combined legends

Another new feature is possibility to combine legends directly, which was quite a hassle in **tmap v3**.

```{r, eval=FALSE, class.source='bg-warning'}
# tmap 3
tm_shape(metro) +
    tm_symbols(col = "pop2020", 
		   n = 4,
		   size = "pop2020",
		   legend.size.show = FALSE,
		   legend.col.show = FALSE) + 
tm_add_legend("symbol", 
			  col = RColorBrewer::brewer.pal(4, "YlOrRd"),
			  border.col = "grey40",
			  size = ((c(10, 20, 30, 40) * 1e6) / 40e6) ^ 0.5 * 2,
			  labels = c("0 mln to 10 mln", "10 mln to 20 mln", "20 mln to 30 mln", "30 mln to 40 mln"),
			  title = "Population in 2020") +
	tm_layout(legend.outside = TRUE, legend.outside.position = "bottom")
```

```{r, class.source='bg-success'}
# tmap 4
tm_shape(metro) +
	tm_symbols(fill = "pop2020",
	           fill.legend = tm_legend("Population in 2020"),
			   size = "pop2020",
			   size.scale = tm_scale_intervals(),
			   size.legend = tm_legend_combine("fill"))
```

### Spacing between items

The design of the legends is (and will further be) improved. 
Most prominently, there is a `space` argument that determines the height of a legend item.
More specifically, each legend item will be `1 + space` line-height. 
This is also useful to make continuous legends better.

## Facets

<!-- A few feature regarding the facets (which were already there) is the `free` argument, which determines whether scales are free across facets or shared. In tmap 4, it is possible to set this not only per aesthetic, but also per dimension (row, column): --> 

```{r, eval = FALSE, class.source='bg-warning'}
# tmap 3
# ... not possible :(
```

```{r, class.source='bg-success'}
# tmap 4
tm_shape(World, crs = "+proj=robin") +
	tm_borders() +
	tm_shape(World) +
	tm_polygons(fill = "life_exp", 
	            fill.scale = tm_scale_intervals(values = tmap_pals$pals.brewer$brewer.greens),
	            fill.free = c(FALSE, TRUE)) +
	tm_symbols(size = "gdp_cap_est", 
	           size.free = c(TRUE, FALSE), 
	           fill = "red") +
	tm_facets_grid("income_grp", "economy") +
	tm_options(meta.margins = c(.2, 0, 0,.1))
```

## Extentions
